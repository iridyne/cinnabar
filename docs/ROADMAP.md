# Cinnabar (朱砂) - 开发路线图

## 当前版本：v1.1.0

### 架构模式

Cinnabar 支持两种运行模式：
- **CLI 模式**：纯终端模式，用于研究和测试语音识别效果（当前已实现）
- **GUI 模式**：悬浮窗模式，按 F3 触发语音输入，自动注入文本（规划中）

### 已完成功能

#### Phase 1: CLI 核心演示 ✅
- [x] 音频捕获与重采样
- [x] 流式语音识别
- [x] 自动断句（已禁用，见已知限制）
- [x] 终端输出

#### Phase 1.5: 音频设备管理 ✅
- [x] 设备枚举和选择（`--list-devices`, `--device`, `--device-name`）
- [x] 音频配置回退机制
- [x] 自动 rpath 配置
- [x] 多声道混音支持（使用 sqrt(channels) 优化）
- [x] 调试模式（`--verbose`）
- [x] 智能句子分割（基于标点符号检测）
- [x] 优化终端输出显示

---

## 短期规划（Phase 2）

### GUI 模式实现

**目标**：实现悬浮窗模式，支持热键触发和自动文本注入

#### Phase 2.1: 基础 GUI 框架（v1.1.0）✅
- [x] 创建 `src/gui/` 模块
- [x] 实现基础悬浮窗（egui + eframe）
- [x] 实现 CLI/GUI 模式切换
- [x] 显示状态信息（待机/监听/识别中）

#### Phase 2.2: 热键集成（v1.2.0）✅
- [x] 集成 `global-hotkey` crate
- [x] 注册 F3 热键
- [x] 实现热键触发语音输入
- [x] 状态机管理（待机 → 监听 → 识别 → 注入）

#### Phase 2.3: 文本注入集成（v1.3.0）✅
- [x] 集成 `TextInjector` 模块（已实现）
- [x] 自动注入识别结果到激活窗口
- [x] 添加注入成功/失败反馈
- [x] 支持中英文混合输入

#### Phase 2.4: 窗口定位（v1.4.0）
- [ ] 实现 Wayland 窗口信息获取
- [ ] 检测激活窗口和输入框位置
- [ ] 悬浮窗自动定位到输入框附近
- [ ] 支持多种定位策略

**技术栈**：
- `egui` (0.30) + `eframe` (0.30) - GUI 框架
- `global-hotkey` (0.6) - 全局热键
- `wayland-client` (0.31) - Wayland 协议
- `arboard` (3.4) + `evdev` (0.12) - 文本注入（已实现）

**Wayland 支持**：
- ✅ Sway, Hyprland, GNOME, KDE Plasma
- 使用 `zwlr_layer_shell_v1` 创建悬浮层
- 使用 `wlr_foreign_toplevel_management` 获取窗口信息

**优先级**：高

---

## 中期规划（Phase 3）

### 高级特性

**语音活动检测（VAD）**：
- [ ] 集成 WebRTC VAD 或 Silero VAD
- [ ] 自动检测说话开始/结束
- [ ] 降低功耗和 CPU 使用率

**多模型支持**：
- [ ] 支持 Whisper 模型
- [ ] 支持 Conformer 模型
- [ ] 模型热切换
- [ ] 模型性能对比

**文本后处理**：
- [ ] 标点符号恢复
- [ ] 自定义词汇注入
- [ ] 说话人分离（可选）

**配置管理**：
- [ ] 配置文件支持（TOML/YAML）
- [ ] 保存用户偏好设置
- [ ] 模型路径配置

**技术栈**：
- `webrtc-vad` (0.4) - VAD 实现
- `whisper-rs` (0.12) - Whisper 模型支持
- `serde` + `toml` (1.0) - 配置文件
- `notify` (7.0) - 文件监听

**优先级**：中

---

## 长期规划（Phase 4）

### 图形界面

**系统托盘**：
- [ ] 系统托盘图标
- [ ] 监听状态可视化
- [ ] 快速启动/停止

**配置面板**：
- [ ] 设备选择界面
- [ ] 模型管理界面
- [ ] 热键配置
- [ ] 主题设置

**实时反馈**：
- [ ] 语音波形显示
- [ ] 识别结果实时预览
- [ ] 识别准确率统计

**技术栈选项**：
- `egui` (0.30) - 轻量级即时模式 GUI
- `iced` (0.13) - Elm 风格声明式 GUI
- `gtk4-rs` (0.9) - Linux 原生外观
- `tauri` (2.1) - Web 技术栈

**优先级**：低

---

## 已知问题与限制

### 当前限制

1. **Endpoint 检测已禁用（已通过替代方案解决）**
   - 原因：sherpa-onnx 库的 `SherpaOnnxOnlineStreamIsEndpoint` 函数存在崩溃问题
   - 替代方案：实现基于标点符号的句子分割（。？！.?!）
   - 影响：通过标点符号检测实现类似的用户体验
   - 状态：已实现替代方案，原问题待调查
   - 优先级：中（已有可用方案）

2. **仅支持 Paraformer 模型**
   - 原因：当前仅实现了 Paraformer 模型的集成
   - 影响：无法使用其他 ASR 模型
   - 状态：Phase 3 规划中
   - 优先级：中

3. **无虚拟键盘功能**
   - 原因：Phase 2 尚未实现
   - 影响：无法直接输入到其他应用程序
   - 状态：Phase 2 规划中
   - 优先级：高

### 技术债务

| 问题 | 优先级 | 状态 | 位置 |
|------|--------|------|------|
| FFI 绑定手动维护 | 低 | 待优化 | `src/ffi/mod.rs` |
| Endpoint 检测崩溃 | 中 | 已绕过 | `src/ffi/mod.rs:L280-291` |
| 缺少单元测试 | 中 | 待实现 | 全局 |
| 缺少配置文件支持 | 中 | Phase 3 | - |
| 编译警告处理 | 低 | ✅ 已完成 | `src/ffi/mod.rs` |
| GUI 模式未实现 | 高 | Phase 2 | - |
| 窗口定位功能 | 中 | Phase 2.4 | - |

---

## 贡献指南

欢迎贡献！优先级排序：

1. **高优先级**：
   - 实现 GUI 模式（Phase 2.1-2.3）
   - 热键集成和文本注入
   - 添加单元测试

2. **中优先级**：
   - 窗口定位功能（Phase 2.4）
   - 修复 endpoint 检测崩溃问题
   - 实现 VAD 功能
   - 配置文件支持

3. **低优先级**：
   - 添加多模型支持
   - 使用 bindgen 自动生成 FFI 绑定
   - 性能优化

---

## 版本历史

- **v1.1.0** (2026-02-03)
  - Phase 2.1-2.3 完成
  - GUI 模式基础实现
  - 创建 RecognizerEngine 模块
  - 实现 egui 悬浮窗
  - 集成全局热键（F3）
  - 集成语音识别和文本注入
  - 状态管理（Idle/Listening/Recognizing/Injecting）

- **v1.0.0** (2026-02-03)
  - Phase 1.5 完成
  - CLI 模式完整实现
  - 设备管理功能（`--list-devices`, `--device`, `--device-name`）
  - 音频优化（配置回退、自动重采样、多声道混音）
  - SIGSEGV 崩溃修复（禁用 endpoint 检测）
  - 智能句子分割（基于标点符号检测）
  - 优化终端输出显示（清空缓冲区、同行更新）
  - 调试模式（`--verbose`）
  - 自动 rpath 配置
  - 文本注入模块（`TextInjector`）
  - 双模式架构设计（CLI/GUI）

- **v0.1.0** (2026-02-03)
  - Phase 1 完成
  - 基础语音识别功能
  - CLI 演示

---

**最后更新**: 2026-02-03 14:42  
**维护者**: Cinnabar Team  
**许可证**: MIT  
**当前状态**: CLI 模式生产就绪，GUI 模式开发中

## 使用指南

### CLI 模式（当前可用）
```/dev/null/bash#L1-5
# 默认 CLI 模式
cargo run --release

# 启用调试输出
cargo run --release -- --verbose
```

### GUI 模式（开发中）
```/dev/null/bash#L1-5
# 启动 GUI 模式（v1.1.0+）
cargo run --release -- --mode gui

# 自定义热键
cargo run --release -- --mode gui --hotkey F4
```