# Cinnabar (朱砂) - 开发路线图

## 当前版本：v1.0.0

### 已完成功能

#### Phase 1: CLI 核心演示 ✅
- [x] 音频捕获与重采样
- [x] 流式语音识别
- [x] 自动断句（已禁用，见已知限制）
- [x] 终端输出

#### Phase 1.5: 音频设备管理 ✅
- [x] 设备枚举和选择（`--list-devices`, `--device`, `--device-name`）
- [x] 音频配置回退机制
- [x] 自动 rpath 配置
- [x] 多声道混音支持
- [x] 调试模式（`--verbose`）

---

## 短期规划（Phase 2）

### 虚拟键盘集成

**目标**：实现语音输入到任意应用程序

**核心功能**：
- [ ] 使用 `uinput` 创建虚拟键盘设备
- [ ] 实现键盘事件注入
- [ ] 热键激活/停止语音输入（如 Ctrl+Space）
- [ ] Unicode 字符输入支持
- [ ] 输入状态指示

**技术栈**：
- `evdev` (0.12) - 虚拟键盘设备创建
- `global-hotkey` (0.6) - 跨平台热键监听
- `tokio` (1.42) - 异步运行时

**权限配置**：
```cinnabar/docs/ROADMAP.md#L40-44
# 一次性设置
sudo usermod -aG input $USER
# 或使用 udev 规则
echo 'KERNEL=="uinput", GROUP="input", MODE="0660"' | sudo tee /etc/udev/rules.d/99-cinnabar.rules
```

**优先级**：高

---

## 中期规划（Phase 3）

### 高级特性

**语音活动检测（VAD）**：
- [ ] 集成 WebRTC VAD 或 Silero VAD
- [ ] 自动检测说话开始/结束
- [ ] 降低功耗和 CPU 使用率

**多模型支持**：
- [ ] 支持 Whisper 模型
- [ ] 支持 Conformer 模型
- [ ] 模型热切换
- [ ] 模型性能对比

**文本后处理**：
- [ ] 标点符号恢复
- [ ] 自定义词汇注入
- [ ] 说话人分离（可选）

**配置管理**：
- [ ] 配置文件支持（TOML/YAML）
- [ ] 保存用户偏好设置
- [ ] 模型路径配置

**技术栈**：
- `webrtc-vad` (0.4) - VAD 实现
- `whisper-rs` (0.12) - Whisper 模型支持
- `serde` + `toml` (1.0) - 配置文件
- `notify` (7.0) - 文件监听

**优先级**：中

---

## 长期规划（Phase 4）

### 图形界面

**系统托盘**：
- [ ] 系统托盘图标
- [ ] 监听状态可视化
- [ ] 快速启动/停止

**配置面板**：
- [ ] 设备选择界面
- [ ] 模型管理界面
- [ ] 热键配置
- [ ] 主题设置

**实时反馈**：
- [ ] 语音波形显示
- [ ] 识别结果实时预览
- [ ] 识别准确率统计

**技术栈选项**：
- `egui` (0.30) - 轻量级即时模式 GUI
- `iced` (0.13) - Elm 风格声明式 GUI
- `gtk4-rs` (0.9) - Linux 原生外观
- `tauri` (2.1) - Web 技术栈

**优先级**：低

---

## 已知问题与限制

### 当前限制

1. **Endpoint 检测已禁用**
   - 原因：sherpa-onnx 库的 `SherpaOnnxOnlineStreamIsEndpoint` 函数存在崩溃问题
   - 影响：无法自动检测说话结束并输出最终结果
   - 状态：待调查
   - 优先级：高

2. **仅支持 Paraformer 模型**
   - 原因：当前仅实现了 Paraformer 模型的集成
   - 影响：无法使用其他 ASR 模型
   - 状态：Phase 3 规划中
   - 优先级：中

3. **无虚拟键盘功能**
   - 原因：Phase 2 尚未实现
   - 影响：无法直接输入到其他应用程序
   - 状态：Phase 2 规划中
   - 优先级：高

### 技术债务

| 问题 | 优先级 | 状态 | 位置 |
|------|--------|------|------|
| FFI 绑定手动维护 | 低 | 待优化 | `src/ffi/mod.rs` |
| Endpoint 检测崩溃 | 高 | 待调查 | `src/ffi/mod.rs:L280-291` |
| 缺少单元测试 | 中 | 待实现 | 全局 |
| 缺少配置文件支持 | 中 | Phase 3 | - |

---

## 贡献指南

欢迎贡献！优先级排序：

1. **高优先级**：
   - 修复 endpoint 检测崩溃问题
   - 实现虚拟键盘集成（Phase 2）
   - 添加单元测试

2. **中优先级**：
   - 实现 VAD 功能
   - 添加多模型支持
   - 配置文件支持

3. **低优先级**：
   - GUI 实现
   - 使用 bindgen 自动生成 FFI 绑定
   - 性能优化

---

## 版本历史

- **v1.0.0** (2026-02-03)
  - Phase 1.5 完成
  - 设备管理功能
  - 音频优化
  - SIGSEGV 崩溃修复

- **v0.1.0** (2026-02-03)
  - Phase 1 完成
  - 基础语音识别功能
  - CLI 演示

---

**最后更新**: 2026-02-03  
**维护者**: Cinnabar Team  
**许可证**: MIT