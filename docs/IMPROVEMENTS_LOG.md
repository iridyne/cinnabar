# Cinnabar 改进日志

## 2026-02-03 - Phase 1.5 实现与修复

### 实现的功能

#### 1. 设备管理功能
- ✅ 添加 `--list-devices` 参数列出所有音频输入设备
- ✅ 添加 `--device <index>` 参数按索引选择设备
- ✅ 添加 `--device-name <name>` 参数按名称选择设备
- ✅ 显示设备的采样率和声道信息

#### 2. 音频配置回退机制
- ✅ 使用 `supported_input_configs()` 检测设备是否支持 16kHz 单声道
- ✅ 如果不支持，自动回退到默认配置并启用软件重采样
- ✅ 实现 `LinearResampler` 线性插值重采样器
- ✅ 支持多声道自动混音为单声道

#### 3. 动态库路径自动配置
- ✅ 添加 `build.rs` 自动配置 rpath
- ✅ Linux 使用 `$ORIGIN` 相对路径
- ✅ macOS 使用 `@executable_path` 相对路径
- ✅ 无需手动设置 `LD_LIBRARY_PATH`

### 修复的问题

#### 初始实现的问题

1. **build.rs 路径计算问题**
   - 问题：使用 `ancestors().nth(3)` 硬编码，依赖目录结构
   - 修复：改用 `$ORIGIN` 和 `$ORIGIN/deps` 相对路径

2. **重采样器缓冲区管理问题**
   - 问题：`consumed` 计算不准确，可能导致音频断裂
   - 修复：保留最后一个样本用于下次插值，确保连续性
   - 问题：没有处理边界情况
   - 修复：添加 `output_len == 0` 检查

3. **配置检测资源浪费**
   - 问题：使用 `build_input_stream` 测试配置
   - 修复：改用 `supported_input_configs()` 查询支持的配置

4. **多声道混音算法优化**
   - 问题：简单平均混音导致音量过小
   - 修复：使用 `sqrt(channels)` 作为除数，保持合理音量

5. **重采样器边界情况处理**
   - 问题：没有处理空输入和缓冲区不足的情况
   - 修复：添加空输入检查、最小样本数检查、缓冲区溢出保护

6. **主循环空数据处理**
   - 问题：重采样后可能返回空数据，导致不必要的处理
   - 修复：添加空数据检查，跳过空结果

7. **SIGSEGV 崩溃问题（关键修复）**
   - 问题：程序在运行时出现段错误，通过 --verbose 调试定位到 `is_endpoint` 函数调用时崩溃
   - 根本原因：sherpa-onnx 库的 `SherpaOnnxOnlineStreamIsEndpoint` FFI 函数存在内部问题
   - 修复：暂时禁用 endpoint 检测功能，返回固定值 `false`
   - 影响：程序可以正常运行，但失去了自动断句功能
   - 后续：需要调查 sherpa-onnx 库的 endpoint 检测问题，或寻找替代方案

8. **调试功能增强**
   - 添加：`--verbose` / `-v` 命令行参数控制详细调试输出
   - 功能：输出音频回调、重采样、FFI 调用等关键步骤的调试信息
   - 用途：帮助定位运行时问题和崩溃位置

### 技术债务状态

| 问题 | 优先级 | 状态 | 位置 |
|------|--------|------|------|
| 手动设置 LD_LIBRARY_PATH | 高 | ✅ 已修复 | build.rs |
| 硬编码 16kHz 配置 | 中 | ✅ 已改进 | src/main.rs + src/resampler.rs |
| 缺少设备选择功能 | 中 | ✅ 已实现 | src/main.rs |
| FFI 绑定手动维护 | 低 | 待优化 | src/ffi/mod.rs |

### 新增文件

- `src/resampler.rs` - 线性插值重采样器实现
- `build.rs` - 自动配置 rpath 的构建脚本
- `docs/IMPROVEMENTS_LOG.md` - 本文档

### 修改文件

- `src/main.rs` - 添加设备管理和配置回退逻辑
- `README.md` - 更新使用说明和版本信息
- `docs/AGENTS.md` - 更新改进建议状态

### 待测试项

- [ ] 在不支持 16kHz 的设备上测试重采样功能
- [ ] 测试多声道设备的混音效果（已优化音量算法）
- [ ] 验证 rpath 配置在不同系统上的有效性
- [ ] 测试设备选择功能的稳定性
- [ ] 测试重采样器的边界情况处理
- [ ] 验证空数据处理的正确性
- [ ] 验证禁用 endpoint 检测后的语音识别效果
- [ ] 测试 --verbose 参数的调试输出功能

### 下一步计划

根据 AGENTS.md 中期改进建议：
- [ ] 使用 `bindgen` 自动生成 FFI 绑定
- [ ] 添加单元测试验证 FFI 调用
- [ ] 研究 sherpa-onnx 的线程安全性

---

**版本**: 0.1.1 (Phase 1.5)  
**状态**: 短期改进已完成，SIGSEGV 崩溃已修复，待实际测试验证  
**最后更新**: 2026-02-03 12:36

### 已知限制

- **Endpoint 检测已禁用**：由于 sherpa-onnx 库的 `SherpaOnnxOnlineStreamIsEndpoint` 函数存在崩溃问题，当前版本已禁用自动断句功能。这意味着程序无法自动检测说话结束并输出最终结果，需要手动停止或等待超时。